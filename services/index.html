<!DOCTYPE html>
<html lang="cz">
  <head>
    <meta name="robots" content="noindex" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Rozpis shromáždění</title>
    <link rel="stylesheet" href="../css/tailwind2.min.css" />
  </head>
  <body class="m-4 bg-gray-100">
    <h1 class="text-3xl">Rozpis shromáždění</h1>
    <div id="app"></div>
    <script type="module">
      import {
        fetchServices,
        fetchEvents,
        fetchPromo,
        mergeServicesToEvents,
        czDateTimeOf,
      } from "../js2/calendar.js";
      /**
       * Renders a service meeting event as HTML using modern template literals
       * @param {Object} service - The service object containing meeting details
       * @returns {string} HTML string for the service meeting
       */
      function renderServiceMeeting(service) {
        const dateInfo = czDateTimeOf(service.date);

        return `
          <div class="mt-8">
            <p>${dateInfo.weekday} <b>${
          dateInfo.day
        }. ${dateInfo.monthName.toLowerCase()}</b> ${dateInfo.year}</p>
            <table>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Vedení</td>
                <td class="align-text-top"><b>${
                  service.moderator || "-"
                }</b></td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Slovo</td>
                <td class="align-text-top"><b>${service.teacher || "-"}</b> ${
          service.subject || ""
        }</td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Poznámky</td>
                <td class="align-text-top">${service.body || "-"}</td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Chvály</td>
                <td class="align-text-top">${service.worshipLeader || "-"}</td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Promítání</td>
                <td class="align-text-top">${service.projector || "-"}</td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Zvukaři</td>
                <td class="align-text-top">${service.soundMaster || "-"}</td>
              </tr>
              <tr>
                <td class="text-sm text-right pr-2 align-text-top">Děti</td>
                <td class="align-text-top">${
                  service.childrenProgram || "-"
                }</td>
              </tr>
              ${
                service.announcements
                  ? `
                <tr>
                  <td class="text-sm text-right pr-2 align-text-top">Oznámení</td>
                  <td class="align-text-top">${service.announcements}</td>
                </tr>
              `
                  : ""
              }
              <tr>
                <td class="text-sm text-right pr-2 align-text-top"><b>Narozeniny</b></td>
                <td class="align-text-top">${(
                  service.birthdays || "-"
                ).replaceAll(", ", "<br />")}</td>
              </tr>
            </table>
          </div>
        `;
      }

      /**
       * Renders all service meetings as HTML
       * @param {Array} services - Array of service objects
       * @returns {string} Complete HTML string for all services
       */
      function renderServiceMeetings(services) {
        return services
          .map((service) => renderServiceMeeting(service))
          .join("");
      }

      /**
       * Formats announcements from events and promo items
       * @param {Array} events - Calendar events
       * @param {Array} promoEvents - Promo events
       * @returns {string} Formatted announcements HTML
       */
      function formatAnnouncements(events, promoEvents) {
        const allEvents = [...events, ...promoEvents]
          .filter((event) => event.start)
          .sort((a, b) => a.start.localeCompare(b.start));

        if (allEvents.length === 0) return "";

        return allEvents
          .map((event) => {
            console.log("Processing event:", event);
            const dateInfo = czDateTimeOf(event.start);
            const endInfo = event.end ? czDateTimeOf(event.end) : null;
            const timeStr = dateInfo.time ? ` ${dateInfo.time}` : "";
            const endStr =
              endInfo && event.end !== event.start
                ? ` - ${endInfo.date}${endInfo.time ? ` ${endInfo.time}` : ""}`
                : "";

            return `${
              dateInfo.date
            }${timeStr}${endStr} <span class="ml-2 font-semibold">${
              event.subject || event.name || "Událost"
            }</span>${event.body ? ` - ${event.body}` : ""}`;
          })
          .join("<br />");
      }

      /**
       * Main application initialization
       */
      async function initializeApp() {
        try {
          // Show loading state
          const appElement = document.getElementById("app");
          appElement.innerHTML = '<div class="mt-8">Načítání...</div>';

          // Fetch all data concurrently
          const [services, events, promoEvents] = await Promise.all([
            fetchServices(),
            fetchEvents(),
            fetchPromo(),
          ]);

          // Merge service data into events
          mergeServicesToEvents(events, services);

          // Add announcements to the first service if there are upcoming events
          if (services.length > 0) {
            const upcomingEvents = events.filter(
              (event) =>
                event.start > services[0].date &&
                (!event.tags.svc || event.tags.important)
            );

            if (upcomingEvents.length > 0 || promoEvents.length > 0) {
              services[0].announcements = formatAnnouncements(
                upcomingEvents,
                promoEvents
              );
            }
          }

          // Render the services to the DOM
          appElement.innerHTML = renderServiceMeetings(services);
        } catch (error) {
          console.error("Error initializing application:", error);
          document.getElementById("app").innerHTML = `
            <div class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
              <strong>Chyba při načítání dat:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Initialize the application when the page loads
      initializeApp();
    </script>
  </body>
</html>
