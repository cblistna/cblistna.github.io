<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar</title>
  </head>
  <body style="background-color: lightgray; padding: 2rem 5rem">
    <h1>Calendar</h1>
    <div id="events"></div>
  </body>
  <script type="module">
    import { ga } from "./google-access.js";
    import { parseGoogleCalendarEvent, now, today } from "./calendar.js";

    const CALENDAR_ID = "trinec.v@cb.cz";
    const SERVICES_SHEET = "1kgTaxURvNYcos2UyGNkaxdqjtJMuqU7Rcftn-bFJ4pI";
    const SERVICES_RANGE = "A1:K20";

    const nowPlus = (ms = 0) =>
      new Date(new Date().getTime() + ms).toISOString();
    const days = (d) => d * 24 * 3600_000;
    const minutes = (m) => m * 60_000;

    await ga.init();

    const allEvents = await ga
      .eventsOf(CALENDAR_ID, {
        timeMin: nowPlus(minutes(30)),
        timeMax: nowPlus(days(200)),
        singleEvents: true,
        orderBy: "startTime",
        maxResults: 200,
      })
      .then(({ items }) =>
        items
          .map((i) => parseGoogleCalendarEvent(i))
          .reduce((acc, event) => {
            if (!acc.has(event.eventId)) {
              acc.set(event.eventId, [event]);
            } else {
              acc.get(event.eventId).push(event);
            }
            return acc;
          }, new Map())
      );
    const events = [...allEvents.entries()]
    // .map(([_, events]) => events.filter((e) => !e.tags.hide))
    .map(([_, events]) => events)
    .map((events) => [events[0], ...events.slice(1).filter((e) => e.tags.important)])
    .flatMap((events) => events)
    .filter((e) => e?.start)
    .sort((a, b) => a.start.localeCompare(b.start))
    console.log(events);
    document.getElementById("events").innerHTML = `
      ${events.map((event) => `
        <p style="font-family: Consolas">
          ${event.start}
          ${event.end}
          ${event.subject}
          ${event.recurring ? "R" : ""}[${Object.entries(event.tags).map(([t, v]) => t)}]
          ${JSON.stringify(event.duration)}
        </p>
      `).join("\n")}`;
  </script>
</html>
